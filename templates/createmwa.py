import re
import os
import hashlib
import time

# ============================================
# CONFIGURATION - CHANGE THESE FOR YOUR APP
# ============================================

# Binary input filename (from make)
inputbin = "MoWatchAPP.bin"

# Output .mwa filename
outputmwa = "SimpleWatch.mwa"

# App icon: 48x48 bitmap, 288 bytes
# Format: horizontal 8-point left-high-bit
# Default icon (clock shape):
appicon_bmp = [
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xFE,0x00,0x00,0x00,0x03,0xFF,0xFF,
0xC0,0x00,0x00,0x0F,0xFF,0xFF,0xF0,0x00,0x00,0x1F,0xFF,0xFF,0xF8,0x00,0x00,0x7F,
0xFF,0xFF,0xFE,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0x80,
0x03,0xFF,0xFF,0xFF,0xFF,0xC0,0x07,0xFF,0xFF,0xFF,0xFF,0xE0,0x07,0xFF,0xFF,0xFF,
0xFF,0xE0,0x0F,0xFF,0xFF,0xFF,0xFF,0xF0,0x0F,0xFF,0xFC,0x3F,0xFF,0xF0,0x1F,0xFF,
0xFC,0x3F,0xFF,0xF8,0x1F,0xFF,0xFC,0x3F,0xFF,0xF8,0x3F,0xFF,0xFC,0x3F,0xFF,0xFC,
0x3F,0xFF,0xFC,0x3F,0xFF,0xFC,0x3F,0xFF,0xFC,0x3F,0xFF,0xFC,0x7F,0xFF,0xFC,0x3F,
0xFF,0xFE,0x7F,0xFF,0xFC,0x3F,0xFF,0xFE,0x7F,0xFF,0xFC,0x3F,0xFF,0xFE,0x7F,0xFF,
0xFC,0x3F,0xFF,0xFE,0x7F,0xFF,0xFC,0x3F,0xFF,0xFE,0x7F,0xFF,0xFC,0x00,0xFF,0xFE,
0x7F,0xFF,0xFC,0x00,0x7F,0xFE,0x7F,0xFF,0xFC,0x00,0x7F,0xFE,0x7F,0xFF,0xFC,0x00,
0x7F,0xFE,0x7F,0xFF,0xFF,0x00,0x7F,0xFE,0x7F,0xFF,0xFF,0x80,0xFF,0xFE,0x3F,0xFF,
0xFF,0xFF,0xFF,0xFC,0x3F,0xFF,0xFF,0xFF,0xFF,0xFC,0x3F,0xFF,0xFF,0xFF,0xFF,0xFC,
0x1F,0xFF,0xFF,0xFF,0xFF,0xF8,0x1F,0xFF,0xFF,0xFF,0xFF,0xF8,0x0F,0xFF,0xFF,0xFF,
0xFF,0xF0,0x0F,0xFF,0xFF,0xFF,0xFF,0xF0,0x07,0xFF,0xFF,0xFF,0xFF,0xE0,0x07,0xFF,
0xFF,0xFF,0xFF,0xE0,0x03,0xFF,0xFF,0xFF,0xFF,0xC0,0x01,0xFF,0xFF,0xFF,0xFF,0x80,
0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x7F,0xFF,0xFF,0xFE,0x00,0x00,0x1F,0xFF,0xFF,
0xF8,0x00,0x00,0x0F,0xFF,0xFF,0xF0,0x00,0x00,0x03,0xFF,0xFF,0xC0,0x00,0x00,0x00,
0x7F,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
]

# App slot (usually 1)
app_slot = 1
app_head_end = 0xFF

# ============================================
# DO NOT MODIFY BELOW THIS LINE
# ============================================

with open("MoWatchAPP.map", "r") as f:
    lines = f.readlines()

init_addr = 0
pattern = re.compile(r"\s+(0x[0-9a-fA-F]+)\s+([a-zA-Z_][a-zA-Z0-9_]*)")
for line in lines:
    match = pattern.match(line)
    if match:
        address, name = match.groups()
        if name == "app_init":
            init_addr = int(address, 16)
            break

if init_addr & 1 == 0:
    init_addr = init_addr | 1

def generate_uuid():
    timestamp = str(time.time()).encode()
    hash_object = hashlib.md5()
    hash_object.update(timestamp)
    md5_hash = hash_object.hexdigest()
    uuid = "{}{}{}{}{}".format(md5_hash[0:8], md5_hash[8:12], md5_hash[12:16], md5_hash[16:20], md5_hash[20:])
    return uuid

uuid = generate_uuid()

with open(inputbin, "rb") as f:
    appbin = f.read()

if os.path.isfile(outputmwa):
    os.remove(outputmwa)
    print(f"Deleted existing {outputmwa}")

with open(outputmwa, "wb+") as fi:
    fi.write(uuid.encode("utf-8"))
    fi.write(init_addr.to_bytes(4, "little"))
    fi.write(app_slot.to_bytes(1, "little"))
    fi.write(app_head_end.to_bytes(1, "little"))
    for bit in appicon_bmp:
        fi.write(bit.to_bytes(1, "little"))
    for byte in appbin:
        fi.write(byte.to_bytes(1, "little"))

print(f"Created {outputmwa} - copy to watch /apps/ folder")
